/*
 * BOREAL NEURO-CORE v2.5 - HIGH-SPEED PREDICTIVE EDITION
 * Optimized for FT232H Synchronous FIFO Interface
 * Features:
 * - 14-Channel Parallel Ingestion
 * - Temporal Predictive Coding (Lead Factor)
 * - Saturation MACC logic
 */

module boreal_hs_core #(
    parameter CHANNELS = 14,
    parameter LEAD_K   = 8'd40  // The "Time Machine" Factor
)(
    input  wire        clk_100m,
    input  wire        rst_n,
    
    // High-Speed FIFO Interface (FT232H Style)
    input  wire [7:0]  fifo_data,
    input  wire        rxf_n,    // Data Available
    output reg         rd_n,     // Read Enable
    
    // Control
    input  wire        bite_halt_n,
    
    // Outputs
    output reg signed [15:0] pred_mu_x,
    output reg signed [15:0] pred_mu_y
);

    // --- 1. HIGH-SPEED PARSER ---
    reg [5:0]  byte_cnt;
    reg [15:0] raw_channels [0:CHANNELS-1];
    reg        frame_valid;
    
    always @(posedge clk_100m or negedge rst_n) begin
        if (!rst_n) begin
            byte_cnt <= 0;
            rd_n <= 1'b1;
            frame_valid <= 1'b0;
        end else begin
            rd_n <= rxf_n; // Follow data availability
            if (!rxf_n) begin
                byte_cnt <= byte_cnt + 1;
                // Parse 28 bytes (14 channels * 16-bit)
                if (byte_cnt < 28) begin
                    if (byte_cnt[0] == 1'b1)
                        raw_channels[byte_cnt >> 1] <= {raw_channels[byte_cnt >> 1][15:8], fifo_data};
                    else
                        raw_channels[byte_cnt >> 1][15:8] <= fifo_data;
                    frame_valid <= 1'b0;
                end else if (byte_cnt == 28) begin
                    frame_valid <= 1'b1; // Trigger math
                    byte_cnt <= 0;
                end
            end else begin
                frame_valid <= 1'b0;
            end
        end
    end

    // --- 2. ACTIVE INFERENCE & PREDICTIVE LEAD ---
    reg signed [15:0] mu_x, mu_y;
    reg signed [15:0] vel_x, vel_y;
    reg signed [15:0] prev_mu_x, prev_mu_y;

    always @(posedge clk_100m) begin
        if (!bite_halt_n) begin
            mu_x <= 0; mu_y <= 0;
        end else if (frame_valid) begin
            // Weighted sum of 14 channels (simplified manifold)
            // Real implementation uses BRAM Weight Matrix W[14][2]
            wire signed [15:0] intent_x = raw_channels[0] + raw_channels[1] - raw_channels[13];
            wire signed [15:0] intent_y = raw_channels[6] + raw_channels[7] - raw_channels[1];

            // Update State (Active Inference)
            mu_x <= mu_x + ((intent_x - mu_x) >>> 4);
            mu_y <= mu_y + ((intent_y - mu_y) >>> 4);

            // Calculate Velocity
            vel_x <= mu_x - prev_mu_x;
            vel_y <= mu_y - prev_mu_y;
            prev_mu_x <= mu_x;
            prev_mu_y <= mu_y;

            // Project Lead: pred = pos + (vel * lead)
            pred_mu_x <= mu_x + ((vel_x * $signed({1'b0, LEAD_K})) >>> 4);
            pred_mu_y <= mu_y + ((vel_y * $signed({1'b0, LEAD_K})) >>> 4);
        end
    end

endmodule

